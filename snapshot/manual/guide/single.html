<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
                      "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
    <head>
        <!-- Global site tag (gtag.js) - Google Analytics -->
        <script src="/cdn-cgi/apps/head/3cOPSgo5Omz84ycX7CvigfX4cpw.js"></script><script async src="https://www.googletagmanager.com/gtag/js?id=UA-82213539-2"></script>
        <script>
            window.dataLayer = window.dataLayer || [];
            function gtag(){dataLayer.push(arguments);}
            gtag('js', new Date());

            gtag('config', 'UA-82213539-2');
        </script>
        <title>spring-security-oauth2-provider 4.0.0.BUILD-SNAPSHOT</title>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
        <link rel="stylesheet" href="../css/main.css" type="text/css" media="screen, print" title="Style" charset="utf-8" />
        <link rel="stylesheet" href="../css/pdf.css" type="text/css" media="print" title="PDF" charset="utf-8" />
    <script type="text/javascript">
function addJsClass(el) {
    var classes = document.body.className.split(" ");
    classes.push("js");
    document.body.className = classes.join(" ");
}
    </script>
    </head>

    <body class="body" onload="addJsClass();">
        <div id="navigation">
            <div class="navTitle">
                
                spring-security-oauth2-provider
            </div>
            <div class="navLinks">
                <ul>
                    <li>
                        <div id="nav-summary" onmouseover="toggleNavSummary(false)" onmouseout="toggleNavSummary(true)">
                            <a href="../guide/index.html" class="button">Table of contents</a>
                            <div id="nav-summary-childs" style="display:none;">
                                
                                <div class="toc-item" style="margin-left:0"><a href="#introduction"><strong>1</strong><span>Introduction to the Spring Security OAuth2 Plugin</span></a></div>
                                
                                <div class="toc-item" style="margin-left:0"><a href="#gettingStarted"><strong>2</strong><span>Getting Started</span></a></div>
                                
                                <div class="toc-item" style="margin-left:0"><a href="#exampleFlows"><strong>3</strong><span>Example Flows</span></a></div>
                                
                                <div class="toc-item" style="margin-left:0"><a href="#domainClasses"><strong>4</strong><span>Required Domain Classes</span></a></div>
                                
                                <div class="toc-item" style="margin-left:0"><a href="#optionalDomainClasses"><strong>5</strong><span>Optional Domain Classes</span></a></div>
                                
                                <div class="toc-item" style="margin-left:0"><a href="#domainClassProperties"><strong>6</strong><span>Domain Class Properties</span></a></div>
                                
                                <div class="toc-item" style="margin-left:0"><a href="#configuration"><strong>7</strong><span>Configuration</span></a></div>
                                
                                <div class="toc-item" style="margin-left:0"><a href="#standaloneResourceAuthorizationServer"><strong>8</strong><span>Standalone Resource Server or Authorization Server</span></a></div>
                                
                            </div>
                        </div>
                    </li>
                    <li class="separator selected">
                        <a id="ref-button" onclick="localToggle(); return false;" href="#">Quick Reference</a>
                    </li>
                </ul>

            </div>
        </div>


        <table id="colset" border="0" cellpadding="0" cellspacing="0">
            <tr>
                <td id="col1">
                    <div id="main" class="corner-all">

                        <span id='toggle-col1' class="toggle">(<a href="#" onclick="localToggle(); return false;">Quick Reference</a>)</span>

                        <div class="project">
                            <h1>spring-security-oauth2-provider</h1>
                            <p><strong>Authors:</strong> </p>
                            <p><strong>Version:</strong> 4.0.0.BUILD-SNAPSHOT</p>
                            
                        </div>

                        
                        <div id="table-of-content">
                            <h2>Table of Contents</h2>
                            
                            <div class="toc-item" style="margin-left:0px"><a href="#introduction"><strong>1</strong><span>Introduction to the Spring Security OAuth2 Plugin</span></a></div>
                            
                            <div class="toc-item" style="margin-left:10px"><a href="#changes"><strong>1.1</strong><span>Change Log</span></a></div>
                            
                            <div class="toc-item" style="margin-left:0px"><a href="#gettingStarted"><strong>2</strong><span>Getting Started</span></a></div>
                            
                            <div class="toc-item" style="margin-left:10px"><a href="#installPlugin"><strong>2.1</strong><span>Install Plugin</span></a></div>
                            
                            <div class="toc-item" style="margin-left:10px"><a href="#createDomainClasses"><strong>2.2</strong><span>Create Domain Classes</span></a></div>
                            
                            <div class="toc-item" style="margin-left:10px"><a href="#secureEndpoints"><strong>2.3</strong><span>Secure Authorization and Token Endpoints</span></a></div>
                            
                            <div class="toc-item" style="margin-left:10px"><a href="#customizeViews"><strong>2.4</strong><span>(Optional) Customize Error and Confirm Access Views</span></a></div>
                            
                            <div class="toc-item" style="margin-left:10px"><a href="#clientRegistration"><strong>2.5</strong><span>Client Registration</span></a></div>
                            
                            <div class="toc-item" style="margin-left:10px"><a href="#resourceAccess"><strong>2.6</strong><span>Controlling Access to Resources</span></a></div>
                            
                            <div class="toc-item" style="margin-left:10px"><a href="#troubleShooting"><strong>2.7</strong><span>Trouble Shooting</span></a></div>
                            
                            <div class="toc-item" style="margin-left:0px"><a href="#exampleFlows"><strong>3</strong><span>Example Flows</span></a></div>
                            
                            <div class="toc-item" style="margin-left:10px"><a href="#authorizationCode"><strong>3.1</strong><span>Authorization Code Grant</span></a></div>
                            
                            <div class="toc-item" style="margin-left:10px"><a href="#implicit"><strong>3.2</strong><span>Implicit Grant</span></a></div>
                            
                            <div class="toc-item" style="margin-left:10px"><a href="#password"><strong>3.3</strong><span>Resource Owner Password Credentials Grant</span></a></div>
                            
                            <div class="toc-item" style="margin-left:10px"><a href="#clientCredentials"><strong>3.4</strong><span>Client Credentials Grant</span></a></div>
                            
                            <div class="toc-item" style="margin-left:10px"><a href="#refreshToken"><strong>3.5</strong><span>Refresh Token Grant</span></a></div>
                            
                            <div class="toc-item" style="margin-left:0px"><a href="#domainClasses"><strong>4</strong><span>Required Domain Classes</span></a></div>
                            
                            <div class="toc-item" style="margin-left:10px"><a href="#clientClass"><strong>4.1</strong><span>Client Class</span></a></div>
                            
                            <div class="toc-item" style="margin-left:10px"><a href="#accessTokenClass"><strong>4.2</strong><span>Access Token Class</span></a></div>
                            
                            <div class="toc-item" style="margin-left:10px"><a href="#refreshTokenClass"><strong>4.3</strong><span>Refresh Token Class</span></a></div>
                            
                            <div class="toc-item" style="margin-left:10px"><a href="#authorizationCodeClass"><strong>4.4</strong><span>Authorization Code Class</span></a></div>
                            
                            <div class="toc-item" style="margin-left:0px"><a href="#optionalDomainClasses"><strong>5</strong><span>Optional Domain Classes</span></a></div>
                            
                            <div class="toc-item" style="margin-left:10px"><a href="#approvalClass"><strong>5.1</strong><span>Approval Class</span></a></div>
                            
                            <div class="toc-item" style="margin-left:0px"><a href="#domainClassProperties"><strong>6</strong><span>Domain Class Properties</span></a></div>
                            
                            <div class="toc-item" style="margin-left:10px"><a href="#clientLookup"><strong>6.1</strong><span>Client Class Properties</span></a></div>
                            
                            <div class="toc-item" style="margin-left:10px"><a href="#accessTokenLookup"><strong>6.2</strong><span>Access Token Class Properties</span></a></div>
                            
                            <div class="toc-item" style="margin-left:10px"><a href="#refreshTokenLookup"><strong>6.3</strong><span>Refresh Token Class Properties</span></a></div>
                            
                            <div class="toc-item" style="margin-left:10px"><a href="#authorizationCodeLookup"><strong>6.4</strong><span>Authorization Code Class Properties</span></a></div>
                            
                            <div class="toc-item" style="margin-left:0px"><a href="#configuration"><strong>7</strong><span>Configuration</span></a></div>
                            
                            <div class="toc-item" style="margin-left:10px"><a href="#plugin"><strong>7.1</strong><span>Plugin</span></a></div>
                            
                            <div class="toc-item" style="margin-left:10px"><a href="#endpoints"><strong>7.2</strong><span>Endpoint URLs</span></a></div>
                            
                            <div class="toc-item" style="margin-left:10px"><a href="#tokenServices"><strong>7.3</strong><span>Token Services</span></a></div>
                            
                            <div class="toc-item" style="margin-left:10px"><a href="#tokenEnhancers"><strong>7.4</strong><span>Token Enhancers Configuration</span></a></div>
                            
                            <div class="toc-item" style="margin-left:10px"><a href="#grantTypes"><strong>7.5</strong><span>Supported Grant Types</span></a></div>
                            
                            <div class="toc-item" style="margin-left:10px"><a href="#authorization"><strong>7.6</strong><span>Additional Authorization Constraints</span></a></div>
                            
                            <div class="toc-item" style="margin-left:10px"><a href="#approvalHandler"><strong>7.7</strong><span>User Approval Configuration</span></a></div>
                            
                            <div class="toc-item" style="margin-left:10px"><a href="#defaultClientConfig"><strong>7.8</strong><span>Default Client Configuration</span></a></div>
                            
                            <div class="toc-item" style="margin-left:10px"><a href="#filterChainConfig"><strong>7.9</strong><span>Filter Chain Configuration</span></a></div>
                            
                            <div class="toc-item" style="margin-left:10px"><a href="#domainClassCustomSerializationConfig"><strong>7.10</strong><span>Domain Class Custom Serialization Configuration</span></a></div>
                            
                            <div class="toc-item" style="margin-left:0px"><a href="#standaloneResourceAuthorizationServer"><strong>8</strong><span>Standalone Resource Server or Authorization Server</span></a></div>
                            
                            <div class="toc-item" style="margin-left:10px"><a href="#authorizationServer"><strong>8.1</strong><span>Authorization Server</span></a></div>
                            
                            <div class="toc-item" style="margin-left:10px"><a href="#resourceServer"><strong>8.2</strong><span>Resource Server</span></a></div>
                            
                            <div style="clear:both" ></div>
                        </div>
                        
                        

<h1 id="introduction">1 Introduction to the Spring Security OAuth2 Plugin</h1>


The OAuth2 plugin adds <a href="http://oauth.net/2/" target="blank">OAuth 2.0</a> support to a Grails application that uses Spring Security. It depends on <a href="http://grails.org/plugin/spring-security-core" target="blank">Spring Security Core plugin</a>.<p class="paragraph"/>Under the covers, <a href="http://projects.spring.io/spring-security-oauth/" target="blank">Spring Security OAuth</a> is used by the plugin to provide OAuth 2.0 services. This documentation specifies a few specific steps you will have to take in order to ensure proper integration with the underlying library.<p class="paragraph"/>This plugin provides support for Grails domain classes necessary for providing OAuth 2.0 authorization. The standard grant types described in <a href="http://tools.ietf.org/html/rfc6749" target="blank">RFC 6749</a> are supported by the plugin. Access to protected resources is controlled by a combination of Spring Security Core's methods, i.e. request maps, annotations, intercept maps and careful configuration of the Spring Security filter chains.


<h2 id="changes">1.1 Change Log</h2>


<ul class="star">
<li>4.0.0-RC1</li>
<ul class="star">
<li>Upgrade to support Grails 4 (pull request #16)</li>
</ul>
<li>3.2.1</li>
<ul class="star">
<li>Fix logging (https://github.com/grails/grails-core/issues/10683)</li>
<li>Upgrade spring-security-oauth2 to 2.0.18 for security fixes</li>
<li>Moved to a new organization (grails-plugins) on GitHub, all PR references below are for the bluesliverx repo</li>
</ul>
<li>3.2.0</li>
<ul class="star">
<li>Bad release, ignore this version</li>
</ul>
<li>3.1.0-RC1</li>
<ul class="star">
<li>Upgrades needed for Grails 3.3.x (PR #141)</li>
<li>Fixes for config loading (PR #139)</li>
</ul>
<li>3.0.0-RC2</li>
<ul class="star">
<li>Upgrade to Spring Security OAuth 2.0.9-RELEASE</li>
<li>Fix issues with Grails 3.1.x (#114, PR #116)</li>
</ul>
<li>3.0.0-RC1</li>
<ul class="star">
<li>Upgrade to Grails 3.x</li>
<li>Make `readAuthentication` in `GormTokenStoreService` null safe (pull request #109)</li>
<li>Upgrade to Spring OAuth 2.0.8.RELEASE</li>
</ul>
<li>2.0-RC5</li>
<ul class="star">
<li>Upgrade to Spring OAuth 2.0.7.RELEASE for compatibility with Spring Security Core RC5 (issue #100)</li>
<li>Resolve minor problems affecting stateless access of OAuth 2.0 resources</li>
<li>Remove need to include `clientCredentialsAuthenticationProvider` in `grails.plugin.springsecurity.providerNames` list</li>
<li>Document using plugin to create only authorization server only or only a resource server (issue #71)</li>
</ul>
<li>2.0-RC4</li>
<ul class="star">
<li>Fix for Grails 2.5.0 (issue #76)</li>
<li>Add support for basic authentication (issue #80)</li>
<li>Fix access token header format in the docs (issue #84)</li>
<li>Throw exception on validation code save (issue #90)</li>
<li>Fixes and enhancements for additional information (issue #87)</li>
<li>Add support for unlimited refresh tokens (issue #75)</li>
</ul>
<li>2.0-RC3</li>
<ul class="star">
<li>Upgrade to Spring OAuth 2.0.6.RELEASE (issue #63)</li>
<li>Fix problems with updating access tokens (issues #49, #50, and #68)</li>
<li>Add TravisCI build</li>
<li>Ensure Set-Cookie header is not set in response</li>
<li>Fix handling of scope parameter (issue #64)</li>
</ul>
<li>2.0-RC2</li>
<ul class="star">
<li>Resolves session vulnerability (issue #42)</li>
<li>Upgrade to Spring Security OAuth2 2.0.4.RELEASE</li>
<li>Supports authorization auto-approval</li>
<li>Minor tweaks to domain models</li>
</ul>
<li>2.0-RC1</li>
<ul class="star">
<li>Complete overhaul of the plugin</li>
<li>Requires/supports Spring Security Core 2.0-RC4</li>
<li>Uses Spring Security OAuth2 2.0.2.RELEASE</li>
</ul>
<li>1.0.5.2</li>
<ul class="star">
<li>Fix #13 - Make clientSecret optional in client configuration structure</li>
</ul>
<li>1.0.5.1</li>
<ul class="star">
<li>Merge pull request #21 (Burt's cleanup)</li>
<li>Use log wrapper instead of log4j</li>
<li>Depends on Grails 2.0 or greater (consistent with core plugin)</li>
</ul>
<li>1.0.5</li>
<ul class="star">
<li>Initial release of plugin compatible with spring security core 2.0-RC2</li>
</ul></ul><p class="paragraph"/>


<h1 id="gettingStarted">2 Getting Started</h1>


The following assumes that the Spring Security Core plugin has been installed and its required domain class created.


<h2 id="installPlugin">2.1 Install Plugin</h2>


Install the OAuth2 plugin by adding a dependency in <code>build.gradle</code>:<p class="paragraph"/><div class="code"><pre>dependencies &#123;
    &#35; For Grails 3.3+
    compile 'org.grails.plugins:spring&#45;security&#45;oauth2&#45;provider:3.2.1'
    &#35; For Grails 3 before 3.3
    compile 'org.grails.plugins:spring&#45;security&#45;oauth2&#45;provider:3.0.0&#45;RC2'
&#125;</pre></div><p class="paragraph"/>This has a dependency on the Spring Security Core plugin, which will be installed if necessary.



<h2 id="createDomainClasses">2.2 Create Domain Classes</h2>


Run the <a href="../ref/Scripts/s2-init-oauth2-provider.html" class="Scripts">s2-init-oauth2-provider</a> script to generate the required domain classes.<p class="paragraph"/>


<h2 id="secureEndpoints">2.3 Secure Authorization and Token Endpoints</h2>


Update the Core plugin's rules for the authorization and token endpoints so they are protected by Spring Security. If you're using the Core plugin's <code>staticRules</code>, you'll want to add the following in <code>grails-app/conf/application.groovy</code>:<p class="paragraph"/><div class="code"><pre>grails.plugin.springsecurity.controllerAnnotations.staticRules = &#91;
        &#91;pattern: '/oauth/authorize',           access: <span class="java&#45;quote">"isFullyAuthenticated() and (request.getMethod().equals('GET') or request.getMethod().equals('POST'))"</span>&#93;,
        &#91;pattern: '/oauth/token',               access: <span class="java&#45;quote">"isFullyAuthenticated() and request.getMethod().equals('POST')"</span>&#93;,
        ...</pre></div><p class="paragraph"/>The endpoints are standard Spring MVC controllers in the underlying Spring Security OAuth2 implementations and the URLs must be mapped with <code>.dispatch</code>.<p class="paragraph"/>The additional restrictions on the allowed HTTP methods are to ensure compliance with the OAuth 2.0 spec as defined in <a href="http://tools.ietf.org/html/rfc6749" target="blank">RFC 6749</a>.



<h2 id="customizeViews">2.4 (Optional) Customize Error and Confirm Access Views</h2>


The plugin provides views for the error and confirm access pages. These can be overridden by providing your own <code>grails-app/views/oauth/error.gsp</code> and <code>grails-app/views/oauth/confirm_access.gsp</code> files, respectively.



<h2 id="clientRegistration">2.5 Client Registration</h2>


At this point your application is a proper OAuth 2.0 provider. You can now register clients in what ever method is appropriate for your application. For example, you can register a client in <code>grails-app/init/Bootstrap.groovy</code> as follows:<p class="paragraph"/><div class="code"><pre>def init = &#123; servletContext &#45;&#62;
        <span class="java&#45;keyword">new</span> Client(
                clientId: 'my&#45;client',
                authorizedGrantTypes: &#91;'authorization_code', 'refresh_token', 'implicit', 'password', 'client_credentials'&#93;,
                authorities: &#91;'ROLE_CLIENT'&#93;,
                scopes: &#91;'read', 'write'&#93;,
                redirectUris: &#91;'http://myredirect.com'&#93;
        ).save(flush: <span class="java&#45;keyword">true</span>)
    &#125;</pre></div>


<h2 id="resourceAccess">2.6 Controlling Access to Resources</h2>


Access to resources is controlled by the Spring Security Core plugin's access control mechanisms. Additionally, the plugin has full support for the OAuth 2.0 SPeL extensions provided by the underlying Spring library. Refer to the methods in <a href="https://github.com/spring-projects/spring-security-oauth/blob/2.0.2.RELEASE/spring-security-oauth2/src/main/java/org/springframework/security/oauth2/provider/expression/OAuth2SecurityExpressionMethods.java" target="blank">OAuth2SecurityExpressionMethods</a> for what is available in the plugin.<p class="paragraph"/>Using SPeL is the only tested and confirmed way to enforce OAuth 2.0 specific restrictions on resource access.<p class="paragraph"/>The following controller illustrates the use of OAuth 2.0 SPeL:<p class="paragraph"/><div class="code"><pre>class SecuredOAuth2ResourcesController &#123;<p class="paragraph"/>    @Secured(&#91;<span class="java&#45;quote">"&#35;oauth2.clientHasRole('ROLE_CLIENT')"</span>&#93;)
    def clientRoleExpression() &#123;
        render <span class="java&#45;quote">"client role expression"</span>
    &#125;<p class="paragraph"/>    @Secured(&#91;<span class="java&#45;quote">"ROLE_CLIENT"</span>&#93;)
    def clientRole() &#123;
        render <span class="java&#45;quote">"client role"</span>
    &#125;<p class="paragraph"/>    @Secured(&#91;<span class="java&#45;quote">"&#35;oauth2.clientHasAnyRole('ROLE_CLIENT', 'ROLE_TRUSTED_CLIENT')"</span>&#93;)
    def clientHasAnyRole() &#123;
        render <span class="java&#45;quote">"client has any role"</span>
    &#125;<p class="paragraph"/>    @Secured(&#91;<span class="java&#45;quote">"&#35;oauth2.isClient()"</span>&#93;)
    def client() &#123;
        render <span class="java&#45;quote">"is client"</span>
    &#125;<p class="paragraph"/>    @Secured(&#91;<span class="java&#45;quote">"&#35;oauth2.isUser()"</span>&#93;)
    def user() &#123;
        render <span class="java&#45;quote">"is user"</span>
    &#125;<p class="paragraph"/>    @Secured(&#91;<span class="java&#45;quote">"&#35;oauth2.denyOAuthClient()"</span>&#93;)
    def denyClient() &#123;
        render <span class="java&#45;quote">"no client can see"</span>
    &#125;<p class="paragraph"/>    @Secured(&#91;<span class="java&#45;quote">"permitAll"</span>&#93;)
    def anyone() &#123;
        render <span class="java&#45;quote">"anyone can see"</span>
    &#125;<p class="paragraph"/>    def nobody() &#123;
        render <span class="java&#45;quote">"nobody can see"</span>
    &#125;<p class="paragraph"/>    @Secured(&#91;<span class="java&#45;quote">"&#35;oauth2.clientHasRole('ROLE_TRUSTED_CLIENT') and &#35;oauth2.isClient() and &#35;oauth2.hasScope('trust')"</span>&#93;)
    def trustedClient() &#123;
        render <span class="java&#45;quote">"trusted client"</span>
    &#125;<p class="paragraph"/>    @Secured(&#91;<span class="java&#45;quote">"hasRole('ROLE_USER') and &#35;oauth2.isUser() and &#35;oauth2.hasScope('trust')"</span>&#93;)
    def trustedUser() &#123;
        render <span class="java&#45;quote">"trusted user"</span>
    &#125;<p class="paragraph"/>    @Secured(&#91;<span class="java&#45;quote">"hasRole('ROLE_USER') or &#35;oauth2.hasScope('read')"</span>&#93;)
    def userRoleOrReadScope() &#123;
        render <span class="java&#45;quote">"user role or read scope"</span>
    &#125;
&#125;</pre></div><p class="paragraph"/>The filter chains must be configured to ensure stateless access to the token endpoint and any OAuth 2.0 resources:<p class="paragraph"/><div class="code"><pre>grails.plugin.springsecurity.filterChain.chainMap = &#91;
        &#91;pattern: '/oauth/token',               filters: 'JOINED_FILTERS,&#45;oauth2ProviderFilter,&#45;securityContextPersistenceFilter,&#45;logoutFilter,&#45;authenticationProcessingFilter,&#45;rememberMeAuthenticationFilter,&#45;exceptionTranslationFilter'&#93;,
        &#91;pattern: '/securedOAuth2Resources/&#42;&#42;', filters: 'JOINED_FILTERS,&#45;securityContextPersistenceFilter,&#45;logoutFilter,&#45;authenticationProcessingFilter,&#45;rememberMeAuthenticationFilter,&#45;oauth2BasicAuthenticationFilter,&#45;exceptionTranslationFilter'&#93;,
        &#91;pattern: '/&#42;&#42;',                        filters: 'JOINED_FILTERS,&#45;statelessSecurityContextPersistenceFilter,&#45;oauth2ProviderFilter,&#45;clientCredentialsTokenEndpointFilter,&#45;oauth2BasicAuthenticationFilter,&#45;oauth2ExceptionTranslationFilter'&#93;
&#93;</pre></div><p class="paragraph"/>Please consult the section on <a href="../guide/single.html#filterChainConfig" class="guide">Filter Chain Configuration</a> for more information.


<h2 id="troubleShooting">2.7 Trouble Shooting</h2>


If an instance of one of the GORM backed classes that the plugin uses cannot be saved, an <code>OAuth2ValidationException</code> will be thrown. This is a subclass of the standard Grails <code>ValidationException</code> so the plugin consumer has the flexibility to determine how to deal with this type of error. The typical reason for this exception being thrown will likely be related to the max size allotted to the serialized <code>OAuth2Authentication</code> fields. The thrown exception can be inspected for further information about the <code>Errors</code>.


<h1 id="exampleFlows">3 Example Flows</h1>


The following examples assume you have followed the steps outlined in the <a href="../guide/single.html#gettingStarted" class="guide">Getting Started</a> section for an application named <code>oauth2-test</code> and your <code>grails-app/init/BootStrap.groovy</code> contains the following:<p class="paragraph"/><div class="code"><pre>def init = &#123; servletContext &#45;&#62;<p class="paragraph"/>    Role roleUser = <span class="java&#45;keyword">new</span> Role(authority: 'ROLE_USER').save(flush: <span class="java&#45;keyword">true</span>)<p class="paragraph"/>    User user = <span class="java&#45;keyword">new</span> User(
         username: 'my&#45;user',
         password: 'my&#45;password',
         enabled: <span class="java&#45;keyword">true</span>,
         accountExpired: <span class="java&#45;keyword">false</span>,
         accountLocked: <span class="java&#45;keyword">false</span>,
         passwordExpired: <span class="java&#45;keyword">false</span>
    ).save(flush: <span class="java&#45;keyword">true</span>)<p class="paragraph"/>    UserRole.create(user, roleUser, <span class="java&#45;keyword">true</span>)<p class="paragraph"/>    <span class="java&#45;keyword">new</span> Client(
        clientId: 'my&#45;client',
        authorizedGrantTypes: &#91;'authorization_code', 'refresh_token', 'implicit', 'password', 'client_credentials'&#93;,
        authorities: &#91;'ROLE_CLIENT'&#93;,
        scopes: &#91;'read', 'write'&#93;,
        redirectUris: &#91;'http://myredirect.com'&#93;
    ).save(flush: <span class="java&#45;keyword">true</span>)
&#125;</pre></div><p class="paragraph"/>After retrieving an <code>access_token</code> via one of the flows, you must include this in the <code>Authorization</code> header when accessing protected resources.<p class="paragraph"/>For example, if you receive <code>7b9a989e-3702-4621-a631-fbd1a996fc94</code> as the <code>access_token</code>, you will include this in the <code>Authorization</code> header as <code>Bearer 7b9a989e-3702-4621-a631-fbd1a996fc94</code> when requesting a protected resource.<p class="paragraph"/>The examples below are given using <a href="http://curl.haxx.se/" target="blank">CURL</a> tool to make the requests. The plugin is compliant with RFC 6749 when configured properly. Therefore token requests should be made using an HTTP POST and authorization requests should be initiated by the User-Agent with an HTTP GET.


<h2 id="authorizationCode">3.1 Authorization Code Grant</h2>


The authorization code grant flow is initiated by directing your browser to the authorization endpoint:<p class="paragraph"/><div class="code"><pre>http://localhost:8080/oauth2&#45;test/oauth/authorize?response_type=code&#38;client_id=my&#45;client&#38;scope=read</pre></div><p class="paragraph"/>You will be redirected to the login page. After signing in, you will be prompted to confirm the request. Doing so will redirect your browser to the following URL:<p class="paragraph"/><div class="code"><pre>http://myredirect.com/?code=139R59</pre></div><p class="paragraph"/>The authorization code included in the query can be exchanged for an access token via the token endpoint:<p class="paragraph"/><div class="code"><pre>curl &#45;X POST &#92;
     &#45;d <span class="java&#45;quote">"client_id=my&#45;client"</span> &#92;
     &#45;d <span class="java&#45;quote">"grant_type=authorization_code"</span> &#92;
     &#45;d <span class="java&#45;quote">"code=139R59"</span> http://localhost:8080/oauth2&#45;test/oauth/token</pre></div><p class="paragraph"/>Using HTTP Basic for client authentication:<p class="paragraph"/><div class="code"><pre>curl &#45;X POST &#45;u my&#45;client: &#92;
     &#45;d <span class="java&#45;quote">"grant_type=authorization_code"</span> &#92;
     &#45;d <span class="java&#45;quote">"code=139R59"</span> http://localhost:8080/oauth2&#45;test/oauth/token</pre></div><p class="paragraph"/>You'll receive the <code>access_token</code> in the response:<p class="paragraph"/><div class="code"><pre>&#123;
    <span class="java&#45;quote">"access_token"</span>: <span class="java&#45;quote">"a1ce2915&#45;8d79&#45;4961&#45;8abb&#45;2c6f0fdb4aba"</span>,
    <span class="java&#45;quote">"token_type"</span>: <span class="java&#45;quote">"bearer"</span>,
    <span class="java&#45;quote">"refresh_token"</span>: <span class="java&#45;quote">"6540222d&#45;0fb9&#45;4b01&#45;8d45&#45;7be2bdfb68f9"</span>,
    <span class="java&#45;quote">"expires_in"</span>: 43199,
    <span class="java&#45;quote">"scope"</span>: <span class="java&#45;quote">"read"</span>
&#125;</pre></div><p class="paragraph"/>


<h2 id="implicit">3.2 Implicit Grant</h2>


The implicit grant is similar to the authorization code grant and can be initiated by directing your browser to the authorization endpoint:<p class="paragraph"/><div class="code"><pre>http://localhost:8080/oauth2&#45;test/oauth/authorize?response_type=token&#38;client_id=my&#45;client&#38;scope=read</pre></div><p class="paragraph"/>Upon confirmation, your browser will be redirected to the following URL:<p class="paragraph"/><div class="code"><pre>http://myredirect.com/&#35;access_token=4e22ad4f&#45;08ae&#45;49dc&#45;befb&#45;2c9821af04d1&#38;token_type=bearer&#38;expires_in=43199</pre></div><p class="paragraph"/>The <code>access_token</code> can be extracted from the URL fragment.


<h2 id="password">3.3 Resource Owner Password Credentials Grant</h2>


The resource owner password grant is performed by requesting an access token from the token endpoint:<p class="paragraph"/><div class="code"><pre>curl &#45;X POST &#92;
     &#45;d <span class="java&#45;quote">"client_id=my&#45;client"</span> &#92;
     &#45;d <span class="java&#45;quote">"grant_type=password"</span> &#92;
     &#45;d <span class="java&#45;quote">"username=my&#45;user"</span> &#92;
     &#45;d <span class="java&#45;quote">"password=my&#45;password"</span> &#92;
     &#45;d <span class="java&#45;quote">"scope=read"</span> http://localhost:8080/oauth2&#45;test/oauth/token</pre></div><p class="paragraph"/>Using HTTP Basic for client authentication:<p class="paragraph"/><div class="code"><pre>curl &#45;X POST &#45;u my&#45;client: &#92;
     &#45;d <span class="java&#45;quote">"grant_type=password"</span> &#92;
     &#45;d <span class="java&#45;quote">"username=my&#45;user"</span> &#92;
     &#45;d <span class="java&#45;quote">"password=my&#45;password"</span> &#92;
     &#45;d <span class="java&#45;quote">"scope=read"</span> http://localhost:8080/oauth2&#45;test/oauth/token</pre></div><p class="paragraph"/>The <code>access_token</code> is included in the response:<p class="paragraph"/><div class="code"><pre>&#123;
    <span class="java&#45;quote">"access_token"</span>: <span class="java&#45;quote">"1d49fc35&#45;2af6&#45;477e&#45;8fd4&#45;ab0353a4a76f"</span>,
    <span class="java&#45;quote">"token_type"</span>: <span class="java&#45;quote">"bearer"</span>,
    <span class="java&#45;quote">"refresh_token"</span>: <span class="java&#45;quote">"4996ba33&#45;be3f&#45;4555&#45;b3e3&#45;0b094a4e60c0"</span>,
    <span class="java&#45;quote">"expires_in"</span>: 43199,
    <span class="java&#45;quote">"scope"</span>: <span class="java&#45;quote">"read"</span>
&#125;</pre></div>


<h2 id="clientCredentials">3.4 Client Credentials Grant</h2>


The client credentials grant is performed by authenticating the client via the token endpoint:<p class="paragraph"/><div class="code"><pre>curl &#45;X POST &#92;
     &#45;d <span class="java&#45;quote">"client_id=my&#45;client"</span> &#92;
     &#45;d <span class="java&#45;quote">"grant_type=client_credentials"</span> &#92;
     &#45;d <span class="java&#45;quote">"scope=read"</span> http://localhost:8080/oauth2&#45;test/oauth/token</pre></div><p class="paragraph"/>Using HTTP Basic for client authentication:<p class="paragraph"/><div class="code"><pre>curl &#45;X POST &#45;u my&#45;client: &#92;
     &#45;d <span class="java&#45;quote">"grant_type=client_credentials"</span> &#92;
     &#45;d <span class="java&#45;quote">"scope=read"</span> http://localhost:8080/oauth2&#45;test/oauth/token</pre></div><p class="paragraph"/>The <code>access_token</code> can be extracted from the response:<p class="paragraph"/><div class="code"><pre>&#123;
    <span class="java&#45;quote">"access_token"</span>: <span class="java&#45;quote">"7b9a989e&#45;3702&#45;4621&#45;a631&#45;fbd1a996fc94"</span>,
    <span class="java&#45;quote">"token_type"</span>: <span class="java&#45;quote">"bearer"</span>,
    <span class="java&#45;quote">"expires_in"</span>: 43199,
    <span class="java&#45;quote">"scope"</span>: <span class="java&#45;quote">"read"</span>
&#125;</pre></div>



<h2 id="refreshToken">3.5 Refresh Token Grant</h2>


The refresh token grant is performed by exchanging a refresh token received during a previous authorization request for an access token from the token endpoint:<p class="paragraph"/><div class="code"><pre>curl &#45;X POST &#92;
     &#45;d <span class="java&#45;quote">"client_id=my&#45;client"</span> &#92;
     &#45;d <span class="java&#45;quote">"grant_type=refresh_token"</span> &#92;
     &#45;d <span class="java&#45;quote">"refresh_token=269afd46&#45;0b41&#45;45c2&#45;a920&#45;7d5af8a38d56"</span> &#92;
     &#45;d <span class="java&#45;quote">"scope=read"</span> http://localhost:8080/oauth2&#45;test/oauth/token</pre></div><p class="paragraph"/>Using HTTP Basic for client authentication:<p class="paragraph"/><div class="code"><pre>curl &#45;X POST &#45;u my&#45;client: &#92;
     &#45;d <span class="java&#45;quote">"grant_type=refresh_token"</span> &#92;
     &#45;d <span class="java&#45;quote">"refresh_token=269afd46&#45;0b41&#45;45c2&#45;a920&#45;7d5af8a38d56"</span> &#92;
     &#45;d <span class="java&#45;quote">"scope=read"</span> http://localhost:8080/oauth2&#45;test/oauth/token</pre></div><p class="paragraph"/>The above assumes that <code>269afd46-0b41-45c2-a920-7d5af8a38d56</code> is the value of the refresh token the client had obtained prior to this request.<p class="paragraph"/>The <code>access_token</code> is included in the response:<p class="paragraph"/><div class="code"><pre>&#123;
    <span class="java&#45;quote">"access_token"</span>: <span class="java&#45;quote">"a3da52c7&#45;4bd2&#45;4d42&#45;a58d&#45;efa64b4de453"</span>,
    <span class="java&#45;quote">"token_type"</span>: <span class="java&#45;quote">"bearer"</span>,
    <span class="java&#45;quote">"refresh_token"</span>: <span class="java&#45;quote">"6396c283&#45;47ff&#45;41d2&#45;b887&#45;39bde6af5f1e"</span>,
    <span class="java&#45;quote">"expires_in"</span>: 43199,
    <span class="java&#45;quote">"scope"</span>: <span class="java&#45;quote">"read"</span>
&#125;</pre></div>


<h1 id="domainClasses">4 Required Domain Classes</h1>


The plugin uses regular Grails domain classes backed by GORM. There are four required domain classes representing clients, access tokens, refresh tokens and authorization codes that you'll need.<p class="paragraph"/>The <a href="../ref/Scripts/s2-init-oauth2-provider.html" class="Scripts">s2-init-oauth2-provider</a> script will create the domain classes for you in a specified package and update <code>grails-app/conf/application.groovy</code> so the plugin recognizes them. You can customize the generated classes to fit your needs. If you change the default property names, you will need to update <code>grails-app/conf/application.groovy</code> so the plugin is aware of the changes. See the section on <a href="../guide/single.html#domainClassProperties" class="guide">domain class properties</a> for more information.<p class="paragraph"/><blockquote class="note">
The <code>maxSize</code> constraints in the generated domain classes have been set to reasonable defaults. However, tweaking may
be required if you are using longer usernames (email addresses for example), or have many authorities attached to a
single user.
</blockquote><p class="paragraph"/>The below discussion assumes the <a href="../ref/Scripts/s2-init-oauth2-provider.html" class="Scripts">s2-init-oauth2-provider</a> script has been run with <code>com.yourapp</code> specified as the package and <code>Client</code>, <code>AccessToken</code>, <code>RefreshToken</code> and <code>AuthorizationCode</code> as the names of your domain classes.


<h2 id="clientClass">4.1 Client Class</h2>


Information from the Grails client domain class will be extracted to create a <code>ClientDetails</code> instance for the underlying Spring Security OAuth 2.0 implementation.<p class="paragraph"/>The generated class will look like this:<p class="paragraph"/><div class="code"><pre><span class="java&#45;keyword">package</span> com.yourapp<p class="paragraph"/>class Client &#123;<p class="paragraph"/>    <span class="java&#45;keyword">private</span> <span class="java&#45;keyword">static</span> <span class="java&#45;keyword">final</span> <span class="java&#45;object">String</span> NO_CLIENT_SECRET = ''<p class="paragraph"/>    <span class="java&#45;keyword">transient</span> springSecurityService<p class="paragraph"/>    <span class="java&#45;object">String</span> clientId
    <span class="java&#45;object">String</span> clientSecret<p class="paragraph"/>    <span class="java&#45;object">Integer</span> accessTokenValiditySeconds
    <span class="java&#45;object">Integer</span> refreshTokenValiditySeconds<p class="paragraph"/>    Map&#60;<span class="java&#45;object">String</span>, <span class="java&#45;object">Object</span>&#62; additionalInformation<p class="paragraph"/>    <span class="java&#45;keyword">static</span> hasMany = &#91;
            authorities: <span class="java&#45;object">String</span>,
            authorizedGrantTypes: <span class="java&#45;object">String</span>,
            resourceIds: <span class="java&#45;object">String</span>,
            scopes: <span class="java&#45;object">String</span>,
            autoApproveScopes: <span class="java&#45;object">String</span>,
            redirectUris: <span class="java&#45;object">String</span>
    &#93;<p class="paragraph"/>    <span class="java&#45;keyword">static</span> transients = &#91;'springSecurityService'&#93;<p class="paragraph"/>    <span class="java&#45;keyword">static</span> constraints = &#123;
        clientId blank: <span class="java&#45;keyword">false</span>, unique: <span class="java&#45;keyword">true</span>
        clientSecret nullable: <span class="java&#45;keyword">true</span><p class="paragraph"/>        accessTokenValiditySeconds nullable: <span class="java&#45;keyword">true</span>
        refreshTokenValiditySeconds nullable: <span class="java&#45;keyword">true</span><p class="paragraph"/>        authorities nullable: <span class="java&#45;keyword">true</span>
        authorizedGrantTypes nullable: <span class="java&#45;keyword">true</span><p class="paragraph"/>        resourceIds nullable: <span class="java&#45;keyword">true</span><p class="paragraph"/>        scopes nullable: <span class="java&#45;keyword">true</span>
        autoApproveScopes nullable: <span class="java&#45;keyword">true</span><p class="paragraph"/>        redirectUris nullable: <span class="java&#45;keyword">true</span>
        additionalInformation nullable: <span class="java&#45;keyword">true</span>
    &#125;<p class="paragraph"/>    def beforeInsert() &#123;
        encodeClientSecret()
    &#125;<p class="paragraph"/>    def beforeUpdate() &#123;
        <span class="java&#45;keyword">if</span>(isDirty('clientSecret')) &#123;
            encodeClientSecret()
        &#125;
    &#125;<p class="paragraph"/>    <span class="java&#45;keyword">protected</span> void encodeClientSecret() &#123;
        clientSecret = clientSecret ?: NO_CLIENT_SECRET
        clientSecret = springSecurityService?.passwordEncoder ? springSecurityService.encodePassword(clientSecret) : clientSecret
    &#125;
&#125;</pre></div><p class="paragraph"/>The client secret is encoded using the same strategy that is configured by the Core plugin for handling passwords. Optional client secrets are also supported out of the box.


<h2 id="accessTokenClass">4.2 Access Token Class</h2>


This class represents an access token than has been issued to a client on behalf of a user. The authentication object serialized is an instance of <code>OAuth2Authentication</code> from Spring Security OAuth 2.0.<p class="paragraph"/><div class="code"><pre><span class="java&#45;keyword">package</span> com.yourapp<p class="paragraph"/>class AccessToken &#123;<p class="paragraph"/>    <span class="java&#45;object">String</span> authenticationKey
    <span class="java&#45;object">byte</span>&#91;&#93; authentication<p class="paragraph"/>    <span class="java&#45;object">String</span> username
    <span class="java&#45;object">String</span> clientId<p class="paragraph"/>    <span class="java&#45;object">String</span> value
    <span class="java&#45;object">String</span> tokenType<p class="paragraph"/>    Date expiration
    Map&#60;<span class="java&#45;object">String</span>, <span class="java&#45;object">Object</span>&#62; additionalInformation<p class="paragraph"/>    <span class="java&#45;keyword">static</span> hasOne = &#91;refreshToken: <span class="java&#45;object">String</span>&#93;
    <span class="java&#45;keyword">static</span> hasMany = &#91;scope: <span class="java&#45;object">String</span>&#93;<p class="paragraph"/>    <span class="java&#45;keyword">static</span> constraints = &#123;
        username nullable: <span class="java&#45;keyword">true</span>
        clientId nullable: <span class="java&#45;keyword">false</span>, blank: <span class="java&#45;keyword">false</span>
        value nullable: <span class="java&#45;keyword">false</span>, blank: <span class="java&#45;keyword">false</span>, unique: <span class="java&#45;keyword">true</span>
        tokenType nullable: <span class="java&#45;keyword">false</span>, blank: <span class="java&#45;keyword">false</span>
        expiration nullable: <span class="java&#45;keyword">false</span>
        scope nullable: <span class="java&#45;keyword">false</span>
        refreshToken nullable: <span class="java&#45;keyword">true</span>
        authenticationKey nullable: <span class="java&#45;keyword">false</span>, blank: <span class="java&#45;keyword">false</span>, unique: <span class="java&#45;keyword">true</span>
        authentication nullable: <span class="java&#45;keyword">false</span>, minSize: 1, maxSize: 1024 &#42; 4
        additionalInformation nullable: <span class="java&#45;keyword">true</span>
    &#125;<p class="paragraph"/>    <span class="java&#45;keyword">static</span> mapping = &#123;
        version <span class="java&#45;keyword">false</span>
        scope lazy: <span class="java&#45;keyword">false</span>
    &#125;
&#125;</pre></div>


<h2 id="refreshTokenClass">4.3 Refresh Token Class</h2>


This class represents a refresh token issued as part of one of the grants that supports issuing a refresh token. The length of time the refresh token is valid is determined by the token services and can be configured. See <a href="../guide/single.html#tokenServices" class="guide">token services configuration</a> for more. The authentication object serialized is an instance of <code>OAuth2Authentication</code> from Spring Security OAuth 2.0.<p class="paragraph"/><div class="code"><pre><span class="java&#45;keyword">package</span> com.yourapp<p class="paragraph"/>class RefreshToken &#123;<p class="paragraph"/>    <span class="java&#45;object">String</span> value
    Date expiration
    <span class="java&#45;object">byte</span>&#91;&#93; authentication<p class="paragraph"/>    <span class="java&#45;keyword">static</span> constraints = &#123;
        value nullable: <span class="java&#45;keyword">false</span>, blank: <span class="java&#45;keyword">false</span>, unique: <span class="java&#45;keyword">true</span>
        expiration nullable: <span class="java&#45;keyword">true</span>
        authentication nullable: <span class="java&#45;keyword">false</span>, minSize: 1, maxSize: 1024 &#42; 4
    &#125;<p class="paragraph"/>    <span class="java&#45;keyword">static</span> mapping = &#123;
        version <span class="java&#45;keyword">false</span>
    &#125;
&#125;</pre></div><p class="paragraph"/>If a non-expiring refresh token is desired, the client issuing the refresh token should be configured to return a 0 or less for the refresh token validity length in accordance with the behavior of Spring Security OAuth beginning with 2.0.6.RELEASE. A non-expiring GORM refresh token will be stored with a <code>null</code> expiration. When reading a GORM refresh token, if the expiration field is <code>null</code>, an <code>ExpiringOAuth2RefreshToken</code> instance will be created and returned for processing by Spring Security OAuth. Otherwise an instance of <code>OAuth2RefreshToken</code> will be created and used.



<h2 id="authorizationCodeClass">4.4 Authorization Code Class</h2>


This class represents an authorization code that has been issued via the authorization endpoint as part of an authorization code grant. The authentication object serialized is an instance of <code>OAuth2Authentication</code> from Spring Security OAuth 2.0.<p class="paragraph"/><div class="code"><pre><span class="java&#45;keyword">package</span> com.yourapp<p class="paragraph"/>class AuthorizationCode &#123;<p class="paragraph"/>    <span class="java&#45;object">byte</span>&#91;&#93; authentication
    <span class="java&#45;object">String</span> code<p class="paragraph"/>    <span class="java&#45;keyword">static</span> constraints = &#123;
        code nullable: <span class="java&#45;keyword">false</span>, blank: <span class="java&#45;keyword">false</span>, unique: <span class="java&#45;keyword">true</span>
        authentication nullable: <span class="java&#45;keyword">false</span>, minSize: 1, maxSize: 1024 &#42; 4
    &#125;<p class="paragraph"/>    <span class="java&#45;keyword">static</span> mapping = &#123;
        version <span class="java&#45;keyword">false</span>
    &#125;
&#125;</pre></div>


<h1 id="optionalDomainClasses">5 Optional Domain Classes</h1>


The plugin provides support for using a GORM backed <code>ApprovalStore</code> with the <code>ApprovalStoreUserApprovalHandler</code> provided by the underlying Spring OAuth library. This class is only required if the consuming application is configured to use the <code>UserApprovalSupport.APPROVAL_STORE</code> method of auto-approval.<p class="paragraph"/>The <a href="../ref/Scripts/s2-init-oauth2-approval.html" class="Scripts">s2-init-oauth2-approval</a> script will create the required domain class for you in a specified package and update <code>grails-app/conf/application.groovy</code> so the plugin recognizes it. You can customize the generated class to fit your needs. If you change the default property names, you will need to update <code>grails-app/conf/application.groovy</code> so the plugin is aware of the changes. See the section on <a href="../guide/single.html#domainClassProperties" class="guide">domain class properties</a> for more information.<p class="paragraph"/>The below discussion assumes the <a href="../ref/Scripts/s2-init-oauth2-approval.html" class="Scripts">s2-init-oauth2-approval</a> script has been run with <code>com.yourapp</code> specified as the package and <code>Approval</code> as the name of the domain class.


<h2 id="approvalClass">5.1 Approval Class</h2>


This class represents a prior scoped approval granted to a client by a user.<p class="paragraph"/><div class="code"><pre><span class="java&#45;keyword">package</span> com.yourapp<p class="paragraph"/>class Approval &#123;<p class="paragraph"/>    <span class="java&#45;object">String</span> username
    <span class="java&#45;object">String</span> clientId<p class="paragraph"/>    <span class="java&#45;object">String</span> scope
    <span class="java&#45;object">boolean</span> approved<p class="paragraph"/>    Date expiration
    Date lastModified<p class="paragraph"/>    <span class="java&#45;keyword">static</span> constraints = &#123;
        username nullable: <span class="java&#45;keyword">false</span>, blank: <span class="java&#45;keyword">false</span>
        clientId nullable: <span class="java&#45;keyword">false</span>, blank: <span class="java&#45;keyword">false</span>
        scope nullable: <span class="java&#45;keyword">false</span>, blank: <span class="java&#45;keyword">false</span>
        expiration nullable: <span class="java&#45;keyword">false</span>
        lastModified nullable: <span class="java&#45;keyword">false</span>
    &#125;
&#125;</pre></div>



<h1 id="domainClassProperties">6 Domain Class Properties</h1>


No default class name is assumed for the required domain classes. They must be specified in <code>grails-app/conf/application.groovy</code>. This is done automatically by the <a href="../ref/Scripts/s2-init-oauth2-provider.html" class="Scripts">s2-init-oauth2-provider</a> script. The following properties exist in the <code>grails.plugin.springsecurity.oauthProvider</code> namespace.



<h2 id="clientLookup">6.1 Client Class Properties</h2>


<table class="wiki-table" cellpadding="0" cellspacing="0" border="0"><tr><th><strong class="bold">Property</strong></th><th><strong class="bold">Default Value</strong></th><th><strong class="bold">Meaning</strong></th></tr><tr class="table-odd"><td>clientLookup.className</td><td><code>null</code></td><td>Client class name.</td></tr><tr class="table-even"><td>clientLookup.clientIdPropertyName</td><td><code>'clientId'</code></td><td>Client class client ID field.</td></tr><tr class="table-odd"><td>clientLookup.clientSecretPropertyName</td><td><code>'clientSecret'</code></td><td>Client class client secret field.</td></tr><tr class="table-even"><td>clientLookup.accessTokenValiditySecondsPropertyName</td><td><code>'accessTokenValiditySeconds'</code></td><td>Client class access token validity length field.</td></tr><tr class="table-odd"><td>clientLookup.refreshTokenValiditySecondsPropertyName</td><td><code>'refreshTokenValiditySeconds'</code></td><td>Client class refresh token validity length field.</td></tr><tr class="table-even"><td>clientLookup.authoritiesPropertyName</td><td><code>'authorities'</code></td><td>Client class authorities field.</td></tr><tr class="table-odd"><td>clientLookup.authorizedGrantTypesPropertyName</td><td><code>'authorizedGrantTypes'</code></td><td>Client class authorized grant types field.</td></tr><tr class="table-even"><td>clientLookup.resourceIdsPropertyName</td><td><code>'resourceIds'</code></td><td>Client class allowed resource IDs field.</td></tr><tr class="table-odd"><td>clientLookup.scopesPropertyName</td><td><code>'scopes'</code></td><td>Client class scopes field.</td></tr><tr class="table-even"><td>clientLookup.autoApproveScopesPropertyName</td><td><code>'autoApproveScopes'</code></td><td>Client class auto-approved scopes field. Including a value of <code>true</code> in the list will auto-approve all scopes for the configured client.</td></tr><tr class="table-odd"><td>clientLookup.redirectUrisPropertyName</td><td><code>'redirectUris'</code></td><td>Client class redirect URIs field.</td></tr><tr class="table-even"><td>clientLookup.additionalInformationPropertyName</td><td><code>'additionalInformation'</code></td><td>Client class additional information field.</td></tr></table>


<h2 id="accessTokenLookup">6.2 Access Token Class Properties</h2>


<table class="wiki-table" cellpadding="0" cellspacing="0" border="0"><tr><th><strong class="bold">Property</strong></th><th><strong class="bold">Default Value</strong></th><th><strong class="bold">Meaning</strong></th></tr><tr class="table-odd"><td>accessTokenLookup.className</td><td><code>null</code></td><td>Access token class name.</td></tr><tr class="table-even"><td>accessTokenLookup.authenticationKeyPropertyName</td><td><code>'authenticationKey'</code></td><td>Access token class serialized authentication key used to locate tokens via serialized authentication field.</td></tr><tr class="table-odd"><td>accessTokenLookup.authenticationPropertyName</td><td><code>'authentication'</code></td><td>Access token class serialized authentication field.</td></tr><tr class="table-even"><td>accessTokenLookup.usernamePropertyName</td><td><code>'username'</code></td><td>Access token class username field.</td></tr><tr class="table-odd"><td>accessTokenLookup.clientIdPropertyName</td><td><code>'clientId'</code></td><td>Access token class client ID field.</td></tr><tr class="table-even"><td>accessTokenLookup.valuePropertyName</td><td><code>'value'</code></td><td>Access token class value field.</td></tr><tr class="table-odd"><td>accessTokenLookup.tokenTypePropertyName</td><td><code>'tokenType'</code></td><td>Access token class token type field.</td></tr><tr class="table-even"><td>accessTokenLookup.expirationPropertyName</td><td><code>'expiration'</code></td><td>Access token class expiration field.</td></tr><tr class="table-odd"><td>accessTokenLookup.refreshTokenPropertyName</td><td><code>'refreshToken'</code></td><td>Access token class refresh token value field.</td></tr><tr class="table-even"><td>accessTokenLookup.scopePropertyName</td><td><code>'scope'</code></td><td>Access token class scope field.</td></tr><tr class="table-odd"><td>accessTokenLookup.additionalInformationPropertyName</td><td><code>'additionalInformation'</code></td><td>Access token class additional information field.</td></tr></table><p class="paragraph"/>Currently only <code>'bearer'</code> tokens are supported.


<h2 id="refreshTokenLookup">6.3 Refresh Token Class Properties</h2>


<table class="wiki-table" cellpadding="0" cellspacing="0" border="0"><tr><th><strong class="bold">Property</strong></th><th><strong class="bold">Default Value</strong></th><th><strong class="bold">Meaning</strong></th></tr><tr class="table-odd"><td>refreshTokenLookup.className</td><td><code>null</code></td><td>Refresh token class name.</td></tr><tr class="table-even"><td>refreshTokenLookup.authenticationPropertyName</td><td><code>'authentication'</code></td><td>Refresh token class serialized authentication field.</td></tr><tr class="table-odd"><td>refreshTokenLookup.valuePropertyName</td><td><code>'value'</code></td><td>Refresh token class value field.</td></tr><tr class="table-even"><td>refreshTokenLookup.expirationPropertyName</td><td><code>'expiration'</code></td><td>Refresh</td></tr></table>


<h2 id="authorizationCodeLookup">6.4 Authorization Code Class Properties</h2>


<table class="wiki-table" cellpadding="0" cellspacing="0" border="0"><tr><th><strong class="bold">Property</strong></th><th><strong class="bold">Default Value</strong></th><th><strong class="bold">Meaning</strong></th></tr><tr class="table-odd"><td>authorizationCodeLookup.className</td><td><code>null</code></td><td>Authorization code class name.</td></tr><tr class="table-even"><td>authorizationCodeLookup.authenticationPropertyName</td><td><code>'authentication'</code></td><td>Authorization code class serialized authentication field.</td></tr><tr class="table-odd"><td>authorizationCodeLookup.codePropertyName</td><td><code>'code'</code></td><td>Authorization code class code field.</td></tr></table>


<h1 id="configuration">7 Configuration</h1>


The plugin is pessimistic by default, locking down as much as possible to guard against accidental security breaches. However, these constraints can be modified if so desired in <code>grails-app/conf/application.groovy</code>. The properties below exist in the <code>grails.plugin.springsecurity.oauthProvider</code> namespace.


<h2 id="plugin">7.1 Plugin</h2>


The following properties define whether the plugin is active and where the required filters are registered in the Spring Security filter chain:<p class="paragraph"/><table class="wiki-table" cellpadding="0" cellspacing="0" border="0"><tr><th><strong class="bold">Property</strong></th><th><strong class="bold">Default Value</strong></th><th><strong class="bold">Meaning</strong></th></tr><tr class="table-odd"><td>active</td><td><code>true</code></td><td>Whether the plugin is enabled.</td></tr><tr class="table-even"><td>filterStartPosition</td><td><code>SecurityFilterPosition.X509_FILTER.order</code></td><td>The position in the filter chain of the <code>OAuth2AuthenticationProcessingFilter</code>, which handles authentication for resource access by extracting an access token from the incoming request.</td></tr><tr class="table-odd"><td>clientFilterStartPosition</td><td><code>SecurityFilterPosition.DIGEST_AUTH_FILTER.order</code></td><td>The position in the filter chain of the <code>ClientCredentialsTokenEndpointFilter</code>, which handles client authentication.</td></tr><tr class="table-even"><td>statelessFilterStartPosition</td><td><code>SecurityFilterPosition.SECURITY_CONTEXT_FILTER.order</code></td><td>The position in the filter chain of the <code>StatelessSecurityContextPersistenceFilter</code>, which is used to ensure access to OAuth 2.0 resources and the token endpoint are stateless.</td></tr><tr class="table-odd"><td>exceptionTranslationFilterStartPosition</td><td><code>SecurityFilterPosition.EXCEPTION_TRANSLATION_FILTER.order</code></td><td>The position in the filter chain of the <code>ExceptionTranslationFilter</code> configured with a <code>NullRequestCache</code>, which is used to ensure access to OAuth 2.0 resources and the token endpoint are stateless.</td></tr><tr class="table-even"><td>basicAuthenticationFilterStartPosition</td><td><code>SecurityFilterPosition.BASIC_AUTH_FILTER.order</code></td><td>The position in the filter chain of the <code>BasicAuthenticationFilter</code> configured with a <code>NullRememberMeServices</code>, which is used to ensure access to OAuth 2.0 resources and the token endpoint are stateless.</td></tr><tr class="table-odd"><td>registerStatelessFilter</td><td><code>true</code></td><td>When this is <code>true</code>, the plugin will register the <code>statelessSecurityContextPersistenceFilter</code> in the filter chain after the <code>securityContextPersistenceFilter</code> provided by the Spring Security Core plugin. See <a href="../guide/single.html#filterChainConfig" class="guide">below</a> for additional configuration of the filter chain(s) required to properly secure access to OAuth 2.0 resources.</td></tr><tr class="table-even"><td>registerExceptionTranslationFilter</td><td><code>true</code></td><td>When this is <code>true</code>, the plugin will register the <code>oauth2ExceptionTranslationFilter</code> in the filter chain after the <code>exceptionTranslationFilter</code> provided by the Spring Security Core plugin. See <a href="../guide/single.html#filterChainConfig" class="guide">below</a> for additional configuration of the filter chain(s) required to properly secure access to OAuth 2.0 resources.</td></tr><tr class="table-odd"><td>registerBasicAuthenticationFilter</td><td><code>true</code></td><td>When this is <code>true</code>, the plugin will register the <code>oauth2BasicAuthenticationFilter</code> in the filter chain after the <code>basicAuthenticationFilter</code> provided by the Spring Security Core plugin. See <a href="../guide/single.html#filterChainConfig" class="guide">below</a> for additional configuration of the filter chain(s) required to properly secure access to OAuth 2.0 resources.</td></tr><tr class="table-even"><td>realmName</td><td><code>Grails OAuth2 Realm</code></td><td>Realm name included in the WWW-Authenticate header in a challenge response.</td></tr></table>


<h2 id="endpoints">7.2 Endpoint URLs</h2>


The endpoint URLs used by the underlying Spring Security OAuth 2.0 implementation can be changed using the following properties:<p class="paragraph"/><table class="wiki-table" cellpadding="0" cellspacing="0" border="0"><tr><th><strong class="bold">Property</strong></th><th><strong class="bold">Default Value</strong></th><th><strong class="bold">Meaning</strong></th></tr><tr class="table-odd"><td>authorizationEndpointUrl</td><td><code>'/oauth/authorize'</code></td><td>Authorization endpoint URL.</td></tr><tr class="table-even"><td>tokenEndpointUrl</td><td><code>'/oauth/token'</code></td><td>Token endpoint URL.</td></tr><tr class="table-odd"><td>userApprovalEndpointUrl</td><td><code>'/oauth/confirm_access'</code></td><td>URL of the view to display for confirming access to protected resources.</td></tr><tr class="table-even"><td>userApprovalParameter</td><td><code>'user_oauth_approval'</code></td><td>The name of the parameter submitted in the confirmation request. The value of this parameter is used to determine whether a user has confirmed (<code>true</code>) or denied (<code>false</code>) access.</td></tr><tr class="table-odd"><td>errorEndpointUrl</td><td><code>'/oauth/error'</code></td><td>URL of the view to display if an error occurs while interacting with the authorization endpoint and the error cannot be returned as part of the query or fragment of the client's redirect URI. This is usually the case when there is a problem with the requesting client's redirect URI.</td></tr></table><p class="paragraph"/>When changing the URL for the <code>authorizationEndpointUrl</code> or <code>tokenEndpointUrl</code>, you <strong class="bold">must</strong> update Spring Security Core's configuration. Using the <code>staticRules</code> configuration and the default configuration as an example, your <code>grails-app/conf/Config.groovy</code> will look like this:<p class="paragraph"/><div class="code"><pre>grails.plugin.springsecurity.controllerAnnotations.staticRules = &#91;
        &#91;pattern: '/oauth/authorize',           access: <span class="java&#45;quote">"isFullyAuthenticated() and (request.getMethod().equals('GET') or request.getMethod().equals('POST'))"</span>&#93;,
        &#91;pattern: '/oauth/token',               access: <span class="java&#45;quote">"isFullyAuthenticated() and request.getMethod().equals('POST')"</span>&#93;,
        ...</pre></div><p class="paragraph"/>To change the <code>authorizationEndpointUrl</code> to <code>/authorize</code>, you will need to make the following changes in <code>grails-app/conf/application.groovy</code>:<p class="paragraph"/><div class="code"><pre>grails.plugin.springsecurity.oauthProvider.authorizationEndpointUrl = '/authorize'<p class="paragraph"/>grails.plugin.springsecurity.controllerAnnotations.staticRules = &#91;
        &#91;pattern: '/authorize',                 access: <span class="java&#45;quote">"isFullyAuthenticated() and (request.getMethod().equals('GET') or request.getMethod().equals('POST'))"</span>&#93;,
        &#91;pattern: '/oauth/token',               access: <span class="java&#45;quote">"isFullyAuthenticated() and request.getMethod().equals('POST')"</span>&#93;,
        ...</pre></div>



<h2 id="tokenServices">7.3 Token Services</h2>


The following properties apply to how tokens are issued and how long they are valid. If a client has defined a specific token validity length, the client's length will take priority over the values configured for the token services.<p class="paragraph"/><table class="wiki-table" cellpadding="0" cellspacing="0" border="0"><tr><th><strong class="bold">Property</strong></th><th><strong class="bold">Default Value</strong></th><th><strong class="bold">Meaning</strong></th></tr><tr class="table-odd"><td>tokenServices.registerTokenEnhancers</td><td><code>true</code></td><td>Whether registered <code>TokenEnhancer</code> instances should be used.</td></tr><tr class="table-even"><td>tokenServices.accessTokenValiditySeconds</td><td><code>60 &#42; 60 &#42; 12</code></td><td>The length of time that an access token will be valid after it has been issued.</td></tr><tr class="table-odd"><td>tokenServices.refreshTokenValiditySeconds</td><td><code>60 &#42; 60 &#42; 24 &#42; 30</code></td><td>The length of time that a refresh token will be valid after it has been issued.</td></tr><tr class="table-even"><td>tokenServices.reuseRefreshToken</td><td><code>false</code></td><td>Whether a new refresh token should be generated if one is currently available.</td></tr><tr class="table-odd"><td>tokenServices.supportRefreshToken</td><td><code>true</code></td><td>Whether a refresh token can be issued upon request.</td></tr></table><p class="paragraph"/>


<h2 id="tokenEnhancers">7.4 Token Enhancers Configuration</h2>


By default, the plugin will register a <code>TokenEnhancerChain</code> with an empty list of <code>TokenEnhancer</code> delegates. When the <code>tokenServices.registerTokenEnhancers</code> option is <code>true</code>, the plugin will detect and use all registered Spring beans implementing the <code>TokenEnhancer</code> interface.<p class="paragraph"/>If more control over the ordering of the enhancers in the chain is desired, set the <code>tokenServices.registerTokenEnhancers</code> option to <code>false</code>. The <code>TokenEnhancerChain</code> bean is registered under the name <code>tokenEnhancerChain</code>, so the plugin consumer can get a handle to it for more fine grained configuration.<p class="paragraph"/>This bean is aliased under the name <code>tokenEnhancer</code>. This is the bean that is registered with the <code>tokenServices</code> bean. This is done to allow customization of the registered enhancer with minimal effort. Just override the <code>tokenEnhancer</code> bean.


<h2 id="grantTypes">7.5 Supported Grant Types</h2>


The following properties determine which of the standard grant types the application can support. Individual clients <strong class="bold">must</strong> declare which of the enabled grant types they support.<p class="paragraph"/><table class="wiki-table" cellpadding="0" cellspacing="0" border="0"><tr><th><strong class="bold">Property</strong></th><th><strong class="bold">Default Value</strong></th><th><strong class="bold">Meaning</strong></th></tr><tr class="table-odd"><td>grantTypes.authorizationCode</td><td><code>true</code></td><td>Whether the Authorization Code Grant is supported.</td></tr><tr class="table-even"><td>grantTypes.implicit</td><td><code>true</code></td><td>Whether the Implicit Grant is supported.</td></tr><tr class="table-odd"><td>grantTypes.clientCredentials</td><td><code>true</code></td><td>Whether the Client Credentials Grant is supported.</td></tr><tr class="table-even"><td>grantTypes.password</td><td><code>true</code></td><td>Whether the Resource Owner Password Credentials is supported.</td></tr><tr class="table-odd"><td>grantTypes.refreshToken</td><td><code>true</code></td><td>Whether Refresh Token Grant is supported.</td></tr></table>



<h2 id="authorization">7.6 Additional Authorization Constraints</h2>


The plugin enforces the following restrictions on authorization request params:<p class="paragraph"/><table class="wiki-table" cellpadding="0" cellspacing="0" border="0"><tr><th><strong class="bold">Property</strong></th><th><strong class="bold">Default Value</strong></th><th><strong class="bold">Meaning</strong></th></tr><tr class="table-odd"><td>authorization.requireRegisteredRedirectUri</td><td><code>true</code></td><td>Whether a client is required to have registered a redirect URI before performing an authorization request. This addresses  <em class="italic">RFC 6749 Section 10.6: Authorization Code Redirection URI Manipulation</em>  and  <em class="italic">RFC 6749 Section 10.15: Open Redirectors</em> .</td></tr><tr class="table-even"><td>authorization.requireScope</td><td><code>true</code></td><td>Whether the scope for each access token requested is required.</td></tr></table>


<h2 id="approvalHandler">7.7 User Approval Configuration</h2>


The plugin provides support for the three <code>UserApprovalHandler</code> implementations provided by the underlying Spring OAuth library. This only applies to the authorization endpoint and allows you to configure the method of auto-approval used by the application. The following properties determine which method of auto-approval to use and how it is configured:<p class="paragraph"/><table class="wiki-table" cellpadding="0" cellspacing="0" border="0"><tr><th><strong class="bold">Property</strong></th><th><strong class="bold">Default Value</strong></th><th><strong class="bold">Meaning</strong></th></tr><tr class="table-odd"><td>auto</td><td><code>EXPLICIT</code></td><td>Determines which method of auto-approval to use. The value is determined by <code>grails.plugin.springsecurity.oauthProvider.approval.UserApprovalSupport</code> and must be <code>EXPLICIT</code>, <code>TOKEN_STORE</code> or <code>APPROVAL_STORE</code>.</td></tr><tr class="table-even"><td>handleRevocationAsExpiry</td><td><code>false</code></td><td>When configured to use an approval store for auto-approval, this determines if approval revocation should expire the corresponding approval instance (<code>true</code>) or delete the approval (<code>false</code>) outright.</td></tr><tr class="table-odd"><td>approvalValiditySeconds</td><td><code>60 &#42; 60 &#42; 24 &#42; 30</code></td><td>When configured to use an approval store for auto-approval, the length of time that an approval will be valid after it has been granted.</td></tr><tr class="table-even"><td>scopePrefix</td><td><code>'scope.'</code></td><td>When configured to use an approval store for auto-approval, the prefix added to approved scopes as part of the auto-approval process.</td></tr></table><p class="paragraph"/>The <code>auto</code> property determines which of the three <code>UserApprovalHandler</code> provided by Spring OAuth will be used.<p class="paragraph"/>The default option is to require explicit approval for every authorization and is equivalent to setting <code>auto</code> to <code>EXPLICIT</code>:<p class="paragraph"/><div class="code"><pre>grails.plugin.springsecurity.oauthprovider.approval.auto = UserApproval.EXPLICIT</pre></div><p class="paragraph"/>Auto-approval based on previously issued access tokens is supported via the <code>TokenStoreUserApprovalHandler</code> provided by Spring OAuth and can be configured by setting <code>auto</code> to <code>TOKEN_STORE</code>:<p class="paragraph"/><div class="code"><pre>grails.plugin.springsecurity.oauthprovider.approval.auto = UserApproval.TOKEN_STORE</pre></div><p class="paragraph"/>Auto-approval based on prior approvals is supported via the <code>ApprovalStoreUserApprovalHandler</code> provided by Spring OAuth and can be configured by setting <code>auto</code> to <code>APPROVAL_STORE</code>:<p class="paragraph"/><div class="code"><pre>grails.plugin.springsecurity.oauthprovider.approval.auto = UserApproval.APPROVAL_STORE</pre></div><p class="paragraph"/>The plugin will configure the <code>TokenStoreUserApprovalHandler</code> and <code>ApprovalStoreUserApprovalHandler</code> to use the GORM backed <code>TokenStore</code> and <code>ApprovalStore</code> respectively.<p class="paragraph"/>Please consult Spring OAuth directly for more information on the usage of the <code>TokenStore</code> and <code>ApprovalStore</code> methods of auto-approval.



<h2 id="defaultClientConfig">7.8 Default Client Configuration</h2>


An application can use the following properties to define the default values that will be used when creating a <code>ClientDetails</code> instance if a client has not specified a value. The default configuration will not allow a client to retrieve an access token unless they have explicitly registered support for the requested grant type.<p class="paragraph"/><table class="wiki-table" cellpadding="0" cellspacing="0" border="0"><tr><th><strong class="bold">Property</strong></th><th><strong class="bold">Default Value</strong></th><th><strong class="bold">Meaning</strong></th></tr><tr class="table-odd"><td>defaultClientConfig.resourceIds</td><td><code>&#91;&#93;</code></td><td>Resources the client is authorized to access. This is currently unused as access to resources is controlled by Spring Security Core's rules.</td></tr><tr class="table-even"><td>defaultClientConfig.authorizedGrantTypes</td><td><code>&#91;&#93;</code></td><td>Grant types the client supports.</td></tr><tr class="table-odd"><td>defaultClientConfig.scope</td><td><code>&#91;&#93;</code></td><td>Scope to use for each access token request.</td></tr><tr class="table-even"><td>defaultClientConfig.autoApproveScopes</td><td><code>&#91;&#93;</code></td><td>Scopes to auto-approve for authorization requests. Including a value of <code>true</code> in the list will auto-approve all scopes for clients using the default configuration.</td></tr><tr class="table-odd"><td>defaultClientConfig.registeredRedirectUri</td><td><code>null</code></td><td>URI to redirect the user-agent to during an authorization code or implicit grant.</td></tr><tr class="table-even"><td>defaultClientConfig.authorities</td><td><code>&#91;&#93;</code></td><td>Roles and authorities granted to the client.</td></tr><tr class="table-odd"><td>defaultClientConfig.accessTokenValiditySeconds</td><td><code>null</code></td><td>The length of time that an access token will be valid after it has been issued. This is used instead of the length configured for token services if available.</td></tr><tr class="table-even"><td>defaultClientConfig.refreshTokenValiditySeconds</td><td><code>null</code></td><td>The length of time that a refresh token will be valid after it has been issued. This is used instead of the length configured for token services if available.</td></tr><tr class="table-odd"><td>defaultClientConfig.additionalInformation</td><td><code>&#91;:&#93;</code></td><td>Additional information about the client. This is not required by OAuth 2.0 but is exposed in the underlying Spring library.</td></tr></table>


<h2 id="filterChainConfig">7.9 Filter Chain Configuration</h2>


Spring Security Core plugin's <code>securityContextPersistenceFilter</code> stores state in the HTTP session. Access to the token endpoint and OAuth 2.0 resources must be stateless.<p class="paragraph"/>By default, the OAuth2 plugin will register the <code>statelessSecurityContextPersistenceFilter</code> in the filter chain after the <code>securityContextPersistenceFilter</code> provided by the Spring Security Core plugin. This is provided as a convenience for the plugin consumer, so they can remove one filter or the other to easily achieve stateful or stateless request handling. See the example below. This automatic filter registration can be disabled by setting the <code>registerStatelessFilter</code> configuration option to <code>false</code>.<p class="paragraph"/>The plugin registers an <code>OAuth2AuthenticationProcessingFilter</code> under the bean name <code>oauth2ProviderFilter</code>. This filter provides token authentication using the underlying token store for resource access.<p class="paragraph"/>The plugin registers a <code>ClientCredentialsTokenEndpointFilter</code> under the bean name <code>clientCredentialsTokenEndpointFilter</code>. This filter is responsible for authenticating the client specified in any OAuth 2.0 requests. The plugin also registers a <code>BasicAuthenticationFilter</code> under the bean name <code>oauth2BasicAuthenticationFilter</code>. This filter is responsible for authenticating the client via HTTP Basic authentication, which is the recommended method in the OAuth 2.0 specification.<p class="paragraph"/>Finally, the plugin registers an <code>ExceptionTranslationFilter</code> under the bean name <code>oauth2ExceptionTranslationFilter</code>. This filter is created with a <code>NullRequestCache</code> instance rather than the <code>HttpSessionRequestCache</code> instance that the Spring Security Core plugin provided <code>ExceptionTranslationFilter</code> is created with. Similar to the <code>statelessSecurityContextPersistenceFilter</code>, this filter is registered automatically by the plugin but can be disabled by setting the <code>registerExceptionTranslationFilter</code> configuration option to <code>false</code>.<p class="paragraph"/>The following filter chain configuration is recommended:<p class="paragraph"/><div class="code"><pre>grails.plugin.springsecurity.filterChain.chainMap = &#91;
        &#91;pattern: '/oauth/token',               filters: 'JOINED_FILTERS,&#45;oauth2ProviderFilter,&#45;securityContextPersistenceFilter,&#45;logoutFilter,&#45;authenticationProcessingFilter,&#45;rememberMeAuthenticationFilter,&#45;exceptionTranslationFilter'&#93;,
        &#91;pattern: '/securedOAuth2Resources/&#42;&#42;', filters: 'JOINED_FILTERS,&#45;securityContextPersistenceFilter,&#45;logoutFilter,&#45;authenticationProcessingFilter,&#45;rememberMeAuthenticationFilter,&#45;oauth2BasicAuthenticationFilter,&#45;exceptionTranslationFilter'&#93;,
        &#91;pattern: '/&#42;&#42;',                        filters: 'JOINED_FILTERS,&#45;statelessSecurityContextPersistenceFilter,&#45;oauth2ProviderFilter,&#45;clientCredentialsTokenEndpointFilter,&#45;oauth2BasicAuthenticationFilter,&#45;oauth2ExceptionTranslationFilter'&#93;
&#93;</pre></div><p class="paragraph"/>The <code>oauth2ProviderFilter</code> and stateful <code>securityContextPersistenceFilter</code> and <code>exceptionTranslationFilter</code> are removed from the token endpoint's filter chain. With the <code>securityContextPersistenceFilter</code> removed, the <code>statelessSecurityContextPersistenceFilter</code> will be used to ensure access token requests are stateless. Similarly, removing the <code>exceptionTranslationFilter</code> will allow the <code>oauth2ExceptionTranslationFilter</code> to take its place in the filter chain.<p class="paragraph"/>The <code>securityContextPersistenceFilter</code> and <code>exceptionTranslationFilter</code> are also removed from the filter chain for OAuth 2.0 resources. However, the <code>oauth2ProviderFilter</code> must not be removed, as this filter is responsible for authenticating the OAuth 2.0 access token included in the request.<p class="paragraph"/>It is recommend that filter chain(s) for non-OAuth 2.0 resources have all OAuth 2.0 specific filters removed. These include: <code>statelessSecurityContextPersistenceFilter</code>, <code>oauth2ProviderFilter</code>, <code>clientCredentialsTokenEndpointFilter</code>, <code>basicAuthenticationFilter</code> and <code>oauth2ExceptionTranslationFilter</code>. It is also recommended that any unnecessary filters such as the <code>rememberMeAuthenticationFilter</code> and <code>authenticationProcessingFilter</code> are removed from the filter chains for the token endpoint and OAuth 2.0 resources.


<h2 id="domainClassCustomSerializationConfig">7.10 Domain Class Custom Serialization Configuration</h2>


The default behavior of the plugin is to serialize the <code>additionalInformation</code> and <code>scope</code> properties of the <code>Client</code> and <code>AccessToken</code> classes as a <code>Map&#60;String, Object&#62;</code> and <code>Set&#60;String&#62;</code> respectively. This is how the <a href="../ref/Scripts/s2-init-oauth2-provider.html" class="Scripts">s2-init-oauth2-provider</a> script will generate the domain classes. However, this might not be ideal for all plugin consumers who want more control over the serialization of these fields.<p class="paragraph"/>To accommodate these users, it is possible to override the default serialization method on a case-by-case basis. The plugin provides two interfaces to accomplish.<p class="paragraph"/>For the <code>additionalInformation</code> fields:<p class="paragraph"/><div class="code"><pre><span class="java&#45;keyword">package</span> grails.plugin.springsecurity.oauthprovider.serialization;<p class="paragraph"/><span class="java&#45;keyword">import</span> java.util.Map;<p class="paragraph"/><span class="java&#45;keyword">public</span> <span class="java&#45;keyword">interface</span> OAuth2AdditionalInformationSerializer &#123;<p class="paragraph"/>    <span class="java&#45;object">Object</span> serialize(Map&#60;<span class="java&#45;object">String</span>, <span class="java&#45;object">Object</span>&#62; additionalInformation);<p class="paragraph"/>    Map&#60;<span class="java&#45;object">String</span>, <span class="java&#45;object">Object</span>&#62; deserialize(<span class="java&#45;object">Object</span> additionalInformation);
&#125;</pre></div><p class="paragraph"/>For the <code>scope</code> field:<p class="paragraph"/><div class="code"><pre><span class="java&#45;keyword">package</span> grails.plugin.springsecurity.oauthprovider.serialization;<p class="paragraph"/><span class="java&#45;keyword">import</span> java.util.Set;<p class="paragraph"/><span class="java&#45;keyword">public</span> <span class="java&#45;keyword">interface</span> OAuth2ScopeSerializer &#123;<p class="paragraph"/>    <span class="java&#45;object">Object</span> serialize(Set&#60;<span class="java&#45;object">String</span>&#62; scopes);<p class="paragraph"/>    Set&#60;<span class="java&#45;object">String</span>&#62; deserialize(<span class="java&#45;object">Object</span> scopes);
&#125;</pre></div><p class="paragraph"/>By default, the plugin registers implementations that do little more than return the argument provided to each method. The following table shows which plugin provided Spring beans implement these interfaces and how they're used:<p class="paragraph"/><table class="wiki-table" cellpadding="0" cellspacing="0" border="0"><tr><th><strong class="bold">Bean Name</strong></th><th><strong class="bold">Interface Implemented</strong></th><th><strong class="bold">Description</strong></th></tr><tr class="table-odd"><td><code>clientAdditionalInformationSerializer</code></td><td><code>OAuth2AdditionalInformationSerializer</code></td><td>Handles deserialization of the <code>additionalInformation</code> property of the <code>Client</code> class into a <code>Map&#60;String, Object&#62;</code>. Only the <code>deserialize</code> method is used by the plugin at this time.</td></tr><tr class="table-even"><td><code>accessTokenAdditionalInformationSerializer</code></td><td><code>OAuth2AdditionalInformationSerializer</code></td><td>Handles serialization and deserialization of the <code>additionalInformation</code> property of the <code>AccessToken</code> class into a <code>Map&#60;String, Object&#62;</code>.</td></tr><tr class="table-odd"><td><code>accessTokenScopeSerializer</code></td><td><code>OAuth2ScopeSerializer</code></td><td>Handles serialization and deserialization of the <code>scope</code> property of the <code>AccessToken</code> class into a <code>Set&#60;String&#62;</code>.</td></tr></table><p class="paragraph"/>Overriding these beans in <code>resources.groovy</code> will allow the plugin consumer to customize how these fields are serialized. However, this will require the affected domain class to be modified to accommodate the change. For example, let's change the <code>AccessToken</code> to serialized its <code>additionalInformation</code> as JSON <code>String</code> and its <code>scope</code> as white space delimited <code>String</code>.<p class="paragraph"/>First, modify the <code>AccessToken</code> class to reflect the change in the storage of these fields:<p class="paragraph"/><div class="code"><pre><span class="java&#45;keyword">package</span> test.oauth2<p class="paragraph"/>class AccessToken &#123;<p class="paragraph"/>    <span class="java&#45;object">String</span> authenticationKey
    <span class="java&#45;object">byte</span>&#91;&#93; authentication<p class="paragraph"/>    <span class="java&#45;object">String</span> username
    <span class="java&#45;object">String</span> clientId<p class="paragraph"/>    <span class="java&#45;object">String</span> value
    <span class="java&#45;object">String</span> tokenType<p class="paragraph"/>    Date expiration
    <span class="java&#45;object">String</span> additionalInformation<p class="paragraph"/>    <span class="java&#45;object">String</span> scope<p class="paragraph"/>    <span class="java&#45;keyword">static</span> hasOne = &#91;refreshToken: <span class="java&#45;object">String</span>&#93;<p class="paragraph"/>    <span class="java&#45;keyword">static</span> constraints = &#123;
        username nullable: <span class="java&#45;keyword">true</span>
        clientId nullable: <span class="java&#45;keyword">false</span>, blank: <span class="java&#45;keyword">false</span>
        value nullable: <span class="java&#45;keyword">false</span>, blank: <span class="java&#45;keyword">false</span>, unique: <span class="java&#45;keyword">true</span>
        tokenType nullable: <span class="java&#45;keyword">false</span>, blank: <span class="java&#45;keyword">false</span>
        expiration nullable: <span class="java&#45;keyword">false</span>
        scope nullable: <span class="java&#45;keyword">false</span>
        refreshToken nullable: <span class="java&#45;keyword">true</span>
        authenticationKey nullable: <span class="java&#45;keyword">false</span>, blank: <span class="java&#45;keyword">false</span>, unique: <span class="java&#45;keyword">true</span>
        authentication nullable: <span class="java&#45;keyword">false</span>, minSize: 1, maxSize: 1024 &#42; 4
        additionalInformation nullable: <span class="java&#45;keyword">true</span>
    &#125;<p class="paragraph"/>    <span class="java&#45;keyword">static</span> mapping = &#123;
        version <span class="java&#45;keyword">false</span>
        scope lazy: <span class="java&#45;keyword">false</span>
    &#125;
&#125;</pre></div><p class="paragraph"/>Next, implement the earlier described interfaces:<p class="paragraph"/><div class="code"><pre><span class="java&#45;keyword">package</span> test<p class="paragraph"/><span class="java&#45;keyword">import</span> grails.plugin.springsecurity.oauthprovider.serialization.OAuth2ScopeSerializer
<span class="java&#45;keyword">import</span> org.springframework.security.oauth2.common.util.OAuth2Utils<p class="paragraph"/>class WhiteSpaceDelimitedStringScopeSerializer <span class="java&#45;keyword">implements</span> OAuth2ScopeSerializer &#123;<p class="paragraph"/>    @Override
    <span class="java&#45;object">Object</span> serialize(Set&#60;<span class="java&#45;object">String</span>&#62; scopes) &#123;
        <span class="java&#45;keyword">return</span> OAuth2Utils.formatParameterList(scopes)
    &#125;<p class="paragraph"/>    @Override
    Set&#60;<span class="java&#45;object">String</span>&#62; deserialize(<span class="java&#45;object">Object</span> scopes) &#123;
        <span class="java&#45;keyword">return</span> OAuth2Utils.parseParameterList(scopes)
    &#125;
&#125;</pre></div><p class="paragraph"/>And:<p class="paragraph"/><div class="code"><pre><span class="java&#45;keyword">package</span> test<p class="paragraph"/><span class="java&#45;keyword">import</span> grails.plugin.springsecurity.oauthprovider.serialization.OAuth2AdditionalInformationSerializer
<span class="java&#45;keyword">import</span> groovy.json.JsonOutput
<span class="java&#45;keyword">import</span> groovy.json.JsonSlurper<p class="paragraph"/>class JsonAdditionalInformationSerializer <span class="java&#45;keyword">implements</span> OAuth2AdditionalInformationSerializer &#123;<p class="paragraph"/>    @Override
    <span class="java&#45;object">Object</span> serialize(Map&#60;<span class="java&#45;object">String</span>, <span class="java&#45;object">Object</span>&#62; additionalInformation) &#123;
        JsonOutput.toJson(additionalInformation)
    &#125;<p class="paragraph"/>    @Override
    Map&#60;<span class="java&#45;object">String</span>, <span class="java&#45;object">Object</span>&#62; deserialize(<span class="java&#45;object">Object</span> additionalInformation) &#123;
        <span class="java&#45;keyword">new</span> JsonSlurper().parseText(additionalInformation as <span class="java&#45;object">String</span>)
    &#125;
&#125;</pre></div><p class="paragraph"/><blockquote class="note">
The <code>serialize</code> methods are guaranteed to receive a non-null argument, although they may be provided an empty collection. The <code>deserialize</code> methods are expected to return a non-null value.
</blockquote><p class="paragraph"/>Finally, in <code>resources.groovy</code>, override the appropriate beans:<p class="paragraph"/><div class="code"><pre><span class="java&#45;keyword">import</span> test.JsonAdditionalInformationSerializer
<span class="java&#45;keyword">import</span> test.WhiteSpaceDelimitedStringScopeSerializer<p class="paragraph"/>beans = &#123;
    // Other beans here<p class="paragraph"/>    accessTokenAdditionalInformationSerializer(JsonAdditionalInformationSerializer)
    accessTokenScopeSerializer(WhiteSpaceDelimitedStringScopeSerializer)
&#125;</pre></div>


<h1 id="standaloneResourceAuthorizationServer">8 Standalone Resource Server or Authorization Server</h1>


By default, the plugin is configured to assume the role of both the Authorization Server and the Resource Server as defined by RFC 6749. However, it is possible to configure an application to fulfill only one role.<p class="paragraph"/>The plugin registers an instance of the Spring OAuth provided <code>OAuth2AuthenticationProcessingFilter</code> under the bean name <code>oauth2ProviderFilter</code>. This filter is responsible for extracting the <code>Bearer</code> token from the <code>Authorization</code> header and confirming its authenticity.



<h2 id="authorizationServer">8.1 Authorization Server</h2>


To create an application that is only an Authorization Server, it is as simple as configuring the authorization and token endpoints as shown in the <a href="../guide/single.html#gettingStarted" class="guide">Getting Started</a> and <a href="../guide/single.html#filterChainConfig" class="guide">Filter Chain Configuration</a> sections and excluding the <code>oauth2ProviderFilter</code>.<p class="paragraph"/>So instead of the following filter chain:<p class="paragraph"/><div class="code"><pre>grails.plugin.springsecurity.filterChain.chainMap = &#91;
            &#91;pattern: '/oauth/token',               filters: 'JOINED_FILTERS,&#45;oauth2ProviderFilter,&#45;securityContextPersistenceFilter,&#45;logoutFilter,&#45;authenticationProcessingFilter,&#45;rememberMeAuthenticationFilter,&#45;exceptionTranslationFilter'&#93;,
            &#91;pattern: '/securedOAuth2Resources/&#42;&#42;', filters: 'JOINED_FILTERS,&#45;securityContextPersistenceFilter,&#45;logoutFilter,&#45;authenticationProcessingFilter,&#45;rememberMeAuthenticationFilter,&#45;oauth2BasicAuthenticationFilter,&#45;exceptionTranslationFilter'&#93;,
            &#91;pattern: '/&#42;&#42;',                        filters: 'JOINED_FILTERS,&#45;statelessSecurityContextPersistenceFilter,&#45;oauth2ProviderFilter,&#45;clientCredentialsTokenEndpointFilter,&#45;oauth2BasicAuthenticationFilter,&#45;oauth2ExceptionTranslationFilter'&#93;
    &#93;</pre></div><p class="paragraph"/>You would have something like this:<p class="paragraph"/><div class="code"><pre>grails.plugin.springsecurity.filterChain.chainMap = &#91;
           &#91;pattern: '/oauth/token',               filters: 'JOINED_FILTERS,&#45;oauth2ProviderFilter,&#45;securityContextPersistenceFilter,&#45;logoutFilter,&#45;rememberMeAuthenticationFilter,&#45;authenticationProcessingFilter,&#45;exceptionTranslationFilter'&#93;,
           &#91;pattern: '/&#42;&#42;',                        filters: 'JOINED_FILTERS,&#45;statelessSecurityContextPersistenceFilter,&#45;oauth2ProviderFilter,&#45;clientCredentialsTokenEndpointFilter,&#45;basicAuthenticationFilter,&#45;oauth2ExceptionTranslationFilter'&#93;
   &#93;</pre></div><p class="paragraph"/>Where <code>/&#42;&#42;</code> is any Authorization Server specific functionality.



<h2 id="resourceServer">8.2 Resource Server</h2>


To create an application that is only a Resource Server is slightly more involved. The plugin uses an implementation of the Spring provided <code>ResourceServerTokenServices</code> interface that uses the currently configured <code>TokenStore</code> to authenticate the presented <code>Bearer</code> token. If the Authorization Server and Resource Server are distinct applications, it is very likely that the Resource Server will need some means to validate the provided <code>Bearer</code> token that depends on your use case. To do this, simply implement the aforementioned <code>ResourceServerTokenServices</code> interface and override the <code>resourceServerTokenServices</code> bean in your <code>resources.groovy</code>.<p class="paragraph"/>Next you will need to disable access to the authorization and token endpoints. This can be accomplished by changing access to the appropriate URL. For example, when using static rules to secure your endpoints, you might have the following when the Authorization and Resource Servers are the same application:<p class="paragraph"/><div class="code"><pre>grails.plugin.springsecurity.controllerAnnotations.staticRules = &#91;
        &#91;pattern: '/oauth/authorize',           access: <span class="java&#45;quote">"isFullyAuthenticated() and (request.getMethod().equals('GET') or request.getMethod().equals('POST'))"</span>&#93;,
        &#91;pattern: '/oauth/token',               access: <span class="java&#45;quote">"isFullyAuthenticated() and request.getMethod().equals('POST')"</span>&#93;,
        &#91;pattern: '/',                          access: 'permitAll'&#93;,
        &#91;pattern: '/index',                     access: 'permitAll'&#93;,
        &#91;pattern: '/index.gsp',                 access: 'permitAll'&#93;,
        &#91;pattern: '/&#42;&#42;/js/&#42;&#42;',                  access: 'permitAll'&#93;,
        &#91;pattern: '/&#42;&#42;/css/&#42;&#42;',                 access: 'permitAll'&#93;,
        &#91;pattern: '/&#42;&#42;/images/&#42;&#42;',              access: 'permitAll'&#93;,
        &#91;pattern: '/&#42;&#42;/favicon.ico',            access: 'permitAll'&#93;,
        &#91;pattern: '/assets/&#42;&#42;',                 access: 'permitAll'&#93;
&#93;</pre></div><p class="paragraph"/>Splitting out the authorization parts will result in something like this:<p class="paragraph"/><div class="code"><pre>grails.plugin.springsecurity.controllerAnnotations.staticRules = &#91;
        &#91;pattern: '/',                          access: 'permitAll'&#93;,
        &#91;pattern: '/index',                     access: 'permitAll'&#93;,
        &#91;pattern: '/index.gsp',                 access: 'permitAll'&#93;,
        &#91;pattern: '/&#42;&#42;/js/&#42;&#42;',                  access: 'permitAll'&#93;,
        &#91;pattern: '/&#42;&#42;/css/&#42;&#42;',                 access: 'permitAll'&#93;,
        &#91;pattern: '/&#42;&#42;/images/&#42;&#42;',              access: 'permitAll'&#93;,
        &#91;pattern: '/&#42;&#42;/favicon.ico',            access: 'permitAll'&#93;,
        &#91;pattern: '/assets/&#42;&#42;',                 access: 'permitAll'&#93;
&#93;</pre></div><p class="paragraph"/>Any requests to the authorization or token endpoints will be greeted with a 403 response. You should also remove any filter chain configurations in place for these endpoints as well. Our earlier filter chain would become something like the following:<p class="paragraph"/><div class="code"><pre>grails.plugin.springsecurity.filterChain.chainMap = &#91;
           &#91;pattern: '/securedOAuth2Resources/&#42;&#42;', filters: 'JOINED_FILTERS,&#45;securityContextPersistenceFilter,&#45;logoutFilter,&#45;rememberMeAuthenticationFilter,&#45;authenticationProcessingFilter,&#45;basicAuthenticationFilter,&#45;exceptionTranslationFilter'&#93;,
           &#91;pattern: '/&#42;&#42;',                        filters: 'JOINED_FILTERS,&#45;statelessSecurityContextPersistenceFilter,&#45;oauth2ProviderFilter,&#45;clientCredentialsTokenEndpointFilter,&#45;basicAuthenticationFilter,&#45;oauth2ExceptionTranslationFilter'&#93;
   &#93;</pre></div><p class="paragraph"/>Where <code>/&#42;&#42;</code> is any Resource Server specific functionality.


                    </div>
                </td>
                <td id="col2">
            <div class="local clearfix">
                <div class="local-title">
                    <a href="../guide/index.html" target="mainFrame">Quick Reference</a>
                    <span class="toggle">(<a href="#" onclick="localToggle(); return false;">hide</a>)</span>
                </div>
                <div class="menu">
                    
                    <div class="menu-block"><h1 class="menu-title" onclick="toggleRef(this.parentNode.childNodes[1])">Scripts</h1><div class="menu-sub">
                        
                        
                        <div class="menu-item"><a href="../ref/Scripts/s2-init-oauth2-approval.html">s2-init-oauth2-approval</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/Scripts/s2-init-oauth2-provider.html">s2-init-oauth2-provider</a>
                        </div>
                        
                        </div>
                    </div>
                    
                </div>
            </div>
        </td>
            </tr>
        </table>

        <div id="footer">
            
            
        </div>



<script type="text/javascript" src="../js/docs.js"></script>

    </body>
</html>
